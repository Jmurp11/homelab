# Homelab Docker Compose for Raspberry Pi 3 (armv7/armhf)
# Domain: murphylab.app / pi3.murphylab.app
# Storage base: /home/pi/docker or /mnt/usb (128GB USB)
# Headscale subnet: 100.64.0.0/10
#
# ENVIRONMENT VARIABLES (set in .env or export before docker-compose up):
# LETSENCRYPT_EMAIL=admin@murphylab.app
# DNS_PROVIDER_API_KEY=your-cloudflare-api-key
# PORTAINER_AGENT_SECRET=secure-agent-secret
# ADGUARD_ADMIN_PASSWORD=secure-adguard-password
# GATUS_ADMIN_PASSWORD=secure-gatus-password
# PI3_IP=192.168.x.x              # REPLACE with actual Pi3 LAN IP
# OPTIPLEX_IP=192.168.x.x         # REPLACE with Optiplex LAN IP (for Portainer agent connection)
#
# NOTE: Pi3 runs low-spec services and an agent for Portainer (server on Optiplex).
# Change `PI3_IP` and `OPTIPLEX_IP` placeholders to actual IPs before bringing up.

networks:
  pi3_net:
    driver: bridge
  headscale_overlay:
    driver: bridge
    ipam:
      config:
        - subnet: 100.64.0.0/10

volumes:
  portainer_agent_data:
  adguard_data:
  adguard_confdir:
  gatus_data:
  beszel_agent_data:
  beszel_socket:

services:

  ####################
  # Portainer Agent (connects to server on Optiplex)
  ####################
  portainer-agent:
    image: portainer/agent:latest
    # For armv7 (Raspberry Pi 3), use: portainer/agent:2.20.3-arm
    container_name: portainer-agent
    restart: unless-stopped
    env_file:
      - .env.common
      - .env.pi3
    environment:
      AGENT_SECRET: ${PORTAINER_AGENT_SECRET}
      AGENT_CLUSTER_ADDR: "portainer-agent:9001"
      AGENT_PORT: "9001"
      LOG_LEVEL: "info"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/lib/docker/volumes:/var/lib/docker/volumes
      - portainer_agent_data:/data
    deploy:
      resources:
        limits:
          cpus: '0.3'
          memory: 128M
    ports:
      - "9001:9001"  # Agent API port (LAN only; Optiplex connects via OPTIPLEX_IP:9001)
    networks:
      - pi3_net
    # NOTE: Agent autodiscovery or manual registration from Portainer Server UI on Optiplex
    # Manual: Portainer UI → Environments → Add Environment → Docker Standalone Edge → 
    #         Agent URL: http://PI3_IP:9001

  ####################
  # AdGuard Home (DNS Sinkhole, VPN-only)
  ####################
  adguard:
    image: adguard/adguardhome:latest
    # For armv7: use adguard/adguardhome:v0.107.x or latest arm32v7
    container_name: adguard
    restart: unless-stopped
    env_file:
      - .env.common
      - .env.pi3
    environment:
      LOG_LEVEL: "info"
    volumes:
      - adguard_confdir:/opt/adguardhome/conf
      - adguard_data:/opt/adguardhome/work
    deploy:
      resources:
        limits:
          cpus: '0.4'
          memory: 256M
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    ports:
      - "53:53/udp"      # DNS
      - "53:53/tcp"      # DNS TCP
      - "3000:3000"      # Web UI (exposed for Traefik reverse proxy)
    networks:
      - pi3_net
      - headscale_overlay
    # NOTE: AdGuard will be exposed via Traefik on Optiplex using dynamic_pi3.yml
    # Labels are not used here; routing defined in traefik/dynamic_pi3.yml

  ####################
  # Gatus (Service Uptime Monitor, VPN-only)
  ####################
  gatus:
    image: twinproduction/gatus:latest
    # For armv7: use twinproduction/gatus:v5.x-arm32v7 or similar (check DockerHub)
    container_name: gatus
    restart: unless-stopped
    env_file:
      - .env.common
      - .env.pi3
    environment:
      GATUS_CONFIG_PATH: /etc/gatus/config.yaml
      LOG_LEVEL: "info"
    volumes:
      - gatus_data:/etc/gatus
      - ./gatus/config.yaml:/etc/gatus/config.yaml:ro
    deploy:
      resources:
        limits:
          cpus: '0.3'
          memory: 128M
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    ports:
      - "8080:8080"  # Web UI (exposed for Traefik reverse proxy)
    networks:
      - pi3_net
      - headscale_overlay
    # NOTE: Gatus will be exposed via Traefik on Optiplex using dynamic_pi3.yml
    # Labels are not used here; routing defined in traefik/dynamic_pi3.yml

  beszel-agent:
    image: henrygd/beszel-agent:latest
    container_name: beszel-agent-pi3
    restart: unless-stopped
    network_mode: host
    env_file:
      - .env.common
      - .env.pi3
    volumes:
      - beszel_agent_data:/var/lib/beszel-agent
      - beszel_socket:/beszel_socket
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - LISTEN=/beszel_socket/beszel.sock
      - HUB_URL=https://beszel.murphylab.app
      - TOKEN=${BESZEL_AGENT_TOKEN}
      - KEY=${BESZEL_AGENT_KEY}
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 64M


  ####################
  # Traefik Agent (optional; for edge routing on Pi3)
  ####################
  # If you want Traefik on Pi3 to serve as an edge router/agent pointing back to Optiplex Traefik:
  # This is OPTIONAL and increases complexity. Recommended: use dynamic_pi3.yml on Optiplex Traefik instead.
  # traefik-agent:
  #   image: traefik:v3.6-arm
  #   container_name: traefik-agent
  #   restart: unless-stopped
  #   command:
  #     - "--configFile=/traefik-agent.yml"
  #   volumes:
  #     - /var/run/docker.sock:/var/run/docker.sock:ro
  #     - ./traefik/traefik-agent.yml:/traefik-agent.yml:ro
  #   deploy:
  #     resources:
  #       limits:
  #         cpus: '0.5'
  #         memory: 256M
  #   ports:
  #     - "80:80"
  #     - "443:443"
  #   networks:
  #     - pi3_net
