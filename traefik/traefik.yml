# Traefik v3.6 Configuration
# Static configuration for Optiplex
# Location: ./traefik/traefik.yml

# Global settings
global:
  checkNewVersion: true
  sendAnonymousUsage: false

# Entrypoints (ports and protocols)
entryPoints:
  # Public internet-facing (HTTP â†’ HTTPS redirect)
  web:
    address: ":80"
    http:
      redirections:
        entrypoint:
          scheme: https
          port: "443"

  # Public HTTPS
  websecure:
    address: ":443"
    http:
      tls:
        certResolver: letsencrypt
        options: default
    http2:
      maxConcurrentStreams: 250
    http3:
      advertisedPort: 443

  # Internal Headscale entrypoint (VPN-only, optional)
  # Use this if you want to bind HTTPS only to Headscale interface IP
  # Otherwise, use IP whitelist middleware (see dynamic files)
  headscale-https:
    address: "0.0.0.0:8443"
    http:
      tls:
        certResolver: letsencrypt
        options: default

  # Traefik Dashboard (insecure, use with caution or bind to localhost)
  traefik-internal:
    address: "127.0.0.1:8080"

# Providers
providers:
  # Docker provider for container labels
  docker:
    endpoint: "unix:///var/run/docker.sock"
    exposedByDefault: false
    swarmMode: false
    network: web  # Default network for service discovery

  # File provider for dynamic configs (Pi3, custom routes, middleware)
  file:
    directory: /dynamic
    watch: true

# API (dashboard and API access)
api:
  insecure: true  # Used for localhost admin dashboard; restrict with middleware
  dashboard: true
  entryPoint: traefik-internal

# Logging
log:
  level: INFO
  filePath: /var/log/traefik/traefik.log
  format: common

# Access logging
accessLog:
  filePath: /var/log/traefik/access.log
  format: common

# Certificate resolvers
certificateResolvers:
  letsencrypt:
    acme:
      email: ${LETSENCRYPT_EMAIL}  # From environment variable
      storage: /acme/acme.json
      
      # HTTP challenge (simpler, no DNS creds needed)
      httpChallenge:
        entryPoint: web
      
      # Alternatively, use DNS challenge (requires provider API key)
      # dnsChallenge:
      #   provider: cloudflare  # Or your DNS provider (route53, godaddy, etc.)
      #   resolvers:
      #     - "1.1.1.1:53"
      #   delayBeforeCheck: 0
      # NOTE: Set DNS_PROVIDER_API_KEY env var (CLOUDFLARE_API_KEY for Cloudflare)
      
      # Certificate expiry warning
      onHostMissingCert: ignore

# TLS Options
tls:
  options:
    default:
      minVersion: VersionTLS12
      cipherSuites:
        - TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
        - TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
        - TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305
        - TLS_AES_128_GCM_SHA256
        - TLS_AES_256_GCM_SHA384
        - TLS_CHACHA20_POLY1305_SHA256
      curvePreferences:
        - CurveP384
      sniStrict: true
    tls13:
      minVersion: VersionTLS13

# Metrics (optional, can enable Prometheus)
# metrics:
#   prometheus:
#     addEntryPointsLabels: true
#     addServicesLabels: true
